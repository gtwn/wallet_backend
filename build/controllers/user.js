const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");

const User = require("../models/user");
const trans = require('../models/transactions');

exports.createUser = (req, res, next) => {
  bcrypt.hash(req.body.password, 10).then(hash => {
    const user = new User({
      account: req.body.Account,
      username: req.body.username,
      firstname: req.body.firstname,
      lastname: req.body.lastname,
      email: req.body.email,
      password: hash,
      balance: req.body.balance,
      transactions: req.body.transactions
    });
    console.log(user);
    user.save().then(result => {
      res.status(201).json({
        message: "User created!",
        result: result
      });
    }).catch(err => {
      res.status(500).json({
        message: "Invalid authentication credentials!"
      });
    });
  });
};

exports.userLogin = (req, res, next) => {
  let fetchedUser;
  User.findOne({ username: req.body.username }).then(user => {
    if (!user) {
      console.log(user);
      return res.status(401).json({
        message: "Auth failed"
      });
    }
    fetchedUser = user;
    return bcrypt.compare(req.body.password, user.password);
  }).then(result => {
    if (!result) {
      return res.status(401).json({
        message: "Auth failed"
      });
    }
    const token = jwt.sign({ username: fetchedUser.username,
      userId: fetchedUser._id,
      account: fetchedUser.account,
      balance: fetchedUser.balance,
      transactions: fetchedUser.transactions }, "secret_this_should_be_longer", { expiresIn: "1h" });
    res.status(200).json({
      token: token,
      expiresIn: 3600,
      userId: fetchedUser._id,
      account: fetchedUser.account,
      balance: fetchedUser.balance,
      transactions: fetchedUser.transactions
    });
  }).catch(err => {
    return res.status(401).json({
      message: "Invalid authentication credentials!"
    });
  });
};

// ดึง profile
exports.getProfile = (req, res, next) => {
  User.findOne({ account: req.params.account }).then(account => {
    // หา account
    if (account) {
      res.status(200).json(account); // ส่งค่าทั้งหมดใน account กลับไป
    } else {
      res.status(404).json({ message: "No account in server!" });
    }
  });
};

// ดึง transaction ของบัญชี ยังไม่เสร็จ
exports.getTransaction = (req, res, next) => {
  trans.find({ accountts: req.params.accountts }).then(transac => {
    if (transac) {
      console.log(transac);
      return res.status(200).json({ transac: transac }); // ต้องมีตัวแปรของหน้าเว็ปมารับค่า transaction ไปด้วยยังไม่ได้ทำ
    } else {
      return res.status(404).json({ message: "No transaction" });
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy91c2VyLmpzIl0sIm5hbWVzIjpbImJjcnlwdCIsInJlcXVpcmUiLCJqd3QiLCJVc2VyIiwidHJhbnMiLCJleHBvcnRzIiwiY3JlYXRlVXNlciIsInJlcSIsInJlcyIsIm5leHQiLCJoYXNoIiwiYm9keSIsInBhc3N3b3JkIiwidGhlbiIsInVzZXIiLCJhY2NvdW50IiwiQWNjb3VudCIsInVzZXJuYW1lIiwiZmlyc3RuYW1lIiwibGFzdG5hbWUiLCJlbWFpbCIsImJhbGFuY2UiLCJ0cmFuc2FjdGlvbnMiLCJjb25zb2xlIiwibG9nIiwic2F2ZSIsInJlc3VsdCIsInN0YXR1cyIsImpzb24iLCJtZXNzYWdlIiwiY2F0Y2giLCJlcnIiLCJ1c2VyTG9naW4iLCJmZXRjaGVkVXNlciIsImZpbmRPbmUiLCJjb21wYXJlIiwidG9rZW4iLCJzaWduIiwidXNlcklkIiwiX2lkIiwiZXhwaXJlc0luIiwiZ2V0UHJvZmlsZSIsInBhcmFtcyIsImdldFRyYW5zYWN0aW9uIiwiZmluZCIsImFjY291bnR0cyIsInRyYW5zYWMiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFNBQVNDLFFBQVEsVUFBUixDQUFmO0FBQ0EsTUFBTUMsTUFBTUQsUUFBUSxjQUFSLENBQVo7O0FBRUEsTUFBTUUsT0FBT0YsUUFBUSxnQkFBUixDQUFiO0FBQ0EsTUFBTUcsUUFBUUgsUUFBUSx3QkFBUixDQUFkOztBQUVBSSxRQUFRQyxVQUFSLEdBQXFCLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJQUFYLEtBQW9CO0FBQ3ZDVCxTQUFPVSxJQUFQLENBQVlILElBQUlJLElBQUosQ0FBU0MsUUFBckIsRUFBK0IsRUFBL0IsRUFBbUNDLElBQW5DLENBQXdDSCxRQUFRO0FBQzlDLFVBQU1JLE9BQU8sSUFBSVgsSUFBSixDQUFTO0FBQ3BCWSxlQUFTUixJQUFJSSxJQUFKLENBQVNLLE9BREU7QUFFcEJDLGdCQUFVVixJQUFJSSxJQUFKLENBQVNNLFFBRkM7QUFHcEJDLGlCQUFXWCxJQUFJSSxJQUFKLENBQVNPLFNBSEE7QUFJcEJDLGdCQUFVWixJQUFJSSxJQUFKLENBQVNRLFFBSkM7QUFLcEJDLGFBQU9iLElBQUlJLElBQUosQ0FBU1MsS0FMSTtBQU1wQlIsZ0JBQVVGLElBTlU7QUFPcEJXLGVBQVNkLElBQUlJLElBQUosQ0FBU1UsT0FQRTtBQVFwQkMsb0JBQWNmLElBQUlJLElBQUosQ0FBU1c7QUFSSCxLQUFULENBQWI7QUFVQUMsWUFBUUMsR0FBUixDQUFZVixJQUFaO0FBQ0FBLFNBQ0dXLElBREgsR0FFR1osSUFGSCxDQUVRYSxVQUFVO0FBQ2RsQixVQUFJbUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQ25CQyxpQkFBUyxlQURVO0FBRW5CSCxnQkFBUUE7QUFGVyxPQUFyQjtBQUlELEtBUEgsRUFRR0ksS0FSSCxDQVFTQyxPQUFPO0FBQ1p2QixVQUFJbUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQ25CQyxpQkFBUztBQURVLE9BQXJCO0FBR0QsS0FaSDtBQWFELEdBekJEO0FBMEJELENBM0JEOztBQTZCQXhCLFFBQVEyQixTQUFSLEdBQW9CLENBQUN6QixHQUFELEVBQU1DLEdBQU4sRUFBV0MsSUFBWCxLQUFvQjtBQUN0QyxNQUFJd0IsV0FBSjtBQUNBOUIsT0FBSytCLE9BQUwsQ0FBYSxFQUFFakIsVUFBVVYsSUFBSUksSUFBSixDQUFTTSxRQUFyQixFQUFiLEVBQ0dKLElBREgsQ0FDUUMsUUFBUTtBQUNaLFFBQUksQ0FBQ0EsSUFBTCxFQUFXO0FBQ1RTLGNBQVFDLEdBQVIsQ0FBWVYsSUFBWjtBQUNBLGFBQU9OLElBQUltQixNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFDMUJDLGlCQUFTO0FBRGlCLE9BQXJCLENBQVA7QUFHRDtBQUNESSxrQkFBY25CLElBQWQ7QUFDQSxXQUFPZCxPQUFPbUMsT0FBUCxDQUFlNUIsSUFBSUksSUFBSixDQUFTQyxRQUF4QixFQUFrQ0UsS0FBS0YsUUFBdkMsQ0FBUDtBQUNELEdBVkgsRUFXR0MsSUFYSCxDQVdRYSxVQUFVO0FBQ2QsUUFBSSxDQUFDQSxNQUFMLEVBQWE7QUFDWCxhQUFPbEIsSUFBSW1CLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUMxQkMsaUJBQVM7QUFEaUIsT0FBckIsQ0FBUDtBQUdEO0FBQ0QsVUFBTU8sUUFBUWxDLElBQUltQyxJQUFKLENBQ1osRUFBRXBCLFVBQVVnQixZQUFZaEIsUUFBeEI7QUFDRXFCLGNBQVFMLFlBQVlNLEdBRHRCO0FBRUV4QixlQUFTa0IsWUFBWWxCLE9BRnZCO0FBR0VNLGVBQVNZLFlBQVlaLE9BSHZCO0FBSUVDLG9CQUFjVyxZQUFZWCxZQUo1QixFQURZLEVBTVosOEJBTlksRUFPWixFQUFFa0IsV0FBVyxJQUFiLEVBUFksQ0FBZDtBQVNBaEMsUUFBSW1CLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUNuQlEsYUFBT0EsS0FEWTtBQUVuQkksaUJBQVcsSUFGUTtBQUduQkYsY0FBUUwsWUFBWU0sR0FIRDtBQUluQnhCLGVBQVNrQixZQUFZbEIsT0FKRjtBQUtuQk0sZUFBU1ksWUFBWVosT0FMRjtBQU1uQkMsb0JBQWNXLFlBQVlYO0FBTlAsS0FBckI7QUFRRCxHQWxDSCxFQW1DR1EsS0FuQ0gsQ0FtQ1NDLE9BQU87QUFDWixXQUFPdkIsSUFBSW1CLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUMxQkMsZUFBUztBQURpQixLQUFyQixDQUFQO0FBR0QsR0F2Q0g7QUF3Q0QsQ0ExQ0Q7O0FBNENBO0FBQ0F4QixRQUFRb0MsVUFBUixHQUFxQixDQUFDbEMsR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsS0FBb0I7QUFDdkNOLE9BQUsrQixPQUFMLENBQWEsRUFBQ25CLFNBQVNSLElBQUltQyxNQUFKLENBQVczQixPQUFyQixFQUFiLEVBQTRDRixJQUE1QyxDQUFpREUsV0FBVztBQUFJO0FBQzlELFFBQUdBLE9BQUgsRUFBVztBQUNUUCxVQUFJbUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCYixPQUFyQixFQURTLENBQzJCO0FBQ3JDLEtBRkQsTUFFTztBQUNMUCxVQUFJbUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLEVBQUdDLFNBQVMsdUJBQVosRUFBckI7QUFDRDtBQUNGLEdBTkQ7QUFRRCxDQVREOztBQVlBO0FBQ0F4QixRQUFRc0MsY0FBUixHQUF5QixDQUFDcEMsR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsS0FBb0I7QUFDM0NMLFFBQU13QyxJQUFOLENBQVcsRUFBQ0MsV0FBV3RDLElBQUltQyxNQUFKLENBQVdHLFNBQXZCLEVBQVgsRUFBOENoQyxJQUE5QyxDQUFtRGlDLFdBQVc7QUFDNUQsUUFBR0EsT0FBSCxFQUFXO0FBQ1R2QixjQUFRQyxHQUFSLENBQVlzQixPQUFaO0FBQ0QsYUFBT3RDLElBQUltQixNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsRUFBQ2tCLFNBQVNBLE9BQVYsRUFBckIsQ0FBUCxDQUZVLENBRTRDO0FBQ3RELEtBSEQsTUFHTztBQUNMLGFBQU90QyxJQUFJbUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLEVBQUVDLFNBQVMsZ0JBQVgsRUFBckIsQ0FBUDtBQUNEO0FBQ0YsR0FQRDtBQVFELENBVEQiLCJmaWxlIjoidXNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGJjcnlwdCA9IHJlcXVpcmUoXCJiY3J5cHRqc1wiKTtcclxuY29uc3Qgand0ID0gcmVxdWlyZShcImpzb253ZWJ0b2tlblwiKTtcclxuXHJcbmNvbnN0IFVzZXIgPSByZXF1aXJlKFwiLi4vbW9kZWxzL3VzZXJcIik7XHJcbmNvbnN0IHRyYW5zID0gcmVxdWlyZSgnLi4vbW9kZWxzL3RyYW5zYWN0aW9ucycpXHJcblxyXG5leHBvcnRzLmNyZWF0ZVVzZXIgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICBiY3J5cHQuaGFzaChyZXEuYm9keS5wYXNzd29yZCwgMTApLnRoZW4oaGFzaCA9PiB7XHJcbiAgICBjb25zdCB1c2VyID0gbmV3IFVzZXIoe1xyXG4gICAgICBhY2NvdW50OiByZXEuYm9keS5BY2NvdW50LFxyXG4gICAgICB1c2VybmFtZTogcmVxLmJvZHkudXNlcm5hbWUsXHJcbiAgICAgIGZpcnN0bmFtZTogcmVxLmJvZHkuZmlyc3RuYW1lLFxyXG4gICAgICBsYXN0bmFtZTogcmVxLmJvZHkubGFzdG5hbWUsXHJcbiAgICAgIGVtYWlsOiByZXEuYm9keS5lbWFpbCxcclxuICAgICAgcGFzc3dvcmQ6IGhhc2gsXHJcbiAgICAgIGJhbGFuY2U6IHJlcS5ib2R5LmJhbGFuY2UsXHJcbiAgICAgIHRyYW5zYWN0aW9uczogcmVxLmJvZHkudHJhbnNhY3Rpb25zXHJcbiAgICB9KTtcclxuICAgIGNvbnNvbGUubG9nKHVzZXIpO1xyXG4gICAgdXNlclxyXG4gICAgICAuc2F2ZSgpXHJcbiAgICAgIC50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oe1xyXG4gICAgICAgICAgbWVzc2FnZTogXCJVc2VyIGNyZWF0ZWQhXCIsXHJcbiAgICAgICAgICByZXN1bHQ6IHJlc3VsdFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICBtZXNzYWdlOiBcIkludmFsaWQgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMhXCJcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydHMudXNlckxvZ2luID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgbGV0IGZldGNoZWRVc2VyO1xyXG4gIFVzZXIuZmluZE9uZSh7IHVzZXJuYW1lOiByZXEuYm9keS51c2VybmFtZSB9KVxyXG4gICAgLnRoZW4odXNlciA9PiB7XHJcbiAgICAgIGlmICghdXNlcikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHVzZXIpO1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICBtZXNzYWdlOiBcIkF1dGggZmFpbGVkXCJcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBmZXRjaGVkVXNlciA9IHVzZXI7XHJcbiAgICAgIHJldHVybiBiY3J5cHQuY29tcGFyZShyZXEuYm9keS5wYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgICAgbWVzc2FnZTogXCJBdXRoIGZhaWxlZFwiXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbihcclxuICAgICAgICB7IHVzZXJuYW1lOiBmZXRjaGVkVXNlci51c2VybmFtZSxcclxuICAgICAgICAgIHVzZXJJZDogZmV0Y2hlZFVzZXIuX2lkLFxyXG4gICAgICAgICAgYWNjb3VudDogZmV0Y2hlZFVzZXIuYWNjb3VudCxcclxuICAgICAgICAgIGJhbGFuY2U6IGZldGNoZWRVc2VyLmJhbGFuY2UsXHJcbiAgICAgICAgICB0cmFuc2FjdGlvbnM6IGZldGNoZWRVc2VyLnRyYW5zYWN0aW9ucyB9LFxyXG4gICAgICAgIFwic2VjcmV0X3RoaXNfc2hvdWxkX2JlX2xvbmdlclwiLFxyXG4gICAgICAgIHsgZXhwaXJlc0luOiBcIjFoXCIgfVxyXG4gICAgICApO1xyXG4gICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgdG9rZW46IHRva2VuLFxyXG4gICAgICAgIGV4cGlyZXNJbjogMzYwMCxcclxuICAgICAgICB1c2VySWQ6IGZldGNoZWRVc2VyLl9pZCxcclxuICAgICAgICBhY2NvdW50OiBmZXRjaGVkVXNlci5hY2NvdW50LFxyXG4gICAgICAgIGJhbGFuY2U6IGZldGNoZWRVc2VyLmJhbGFuY2UsXHJcbiAgICAgICAgdHJhbnNhY3Rpb25zOiBmZXRjaGVkVXNlci50cmFuc2FjdGlvbnNcclxuICAgICAgfSk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgbWVzc2FnZTogXCJJbnZhbGlkIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzIVwiXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8vIOC4lOC4tuC4hyBwcm9maWxlXHJcbmV4cG9ydHMuZ2V0UHJvZmlsZSA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gIFVzZXIuZmluZE9uZSh7YWNjb3VudDogcmVxLnBhcmFtcy5hY2NvdW50fSkudGhlbihhY2NvdW50ID0+IHsgICAvLyDguKvguLIgYWNjb3VudFxyXG4gICAgaWYoYWNjb3VudCl7XHJcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKGFjY291bnQpOyAgICAgIC8vIOC4quC5iOC4h+C4hOC5iOC4suC4l+C4seC5ieC4h+C4q+C4oeC4lOC5g+C4mSBhY2NvdW50IOC4geC4peC4seC4muC5hOC4m1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVzLnN0YXR1cyg0MDQpLmpzb24oeyAgbWVzc2FnZTogXCJObyBhY2NvdW50IGluIHNlcnZlciFcIn0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxufVxyXG5cclxuXHJcbi8vIOC4lOC4tuC4hyB0cmFuc2FjdGlvbiDguILguK3guIfguJrguLHguI3guIrguLUg4Lii4Lix4LiH4LmE4Lih4LmI4LmA4Liq4Lij4LmH4LiIXHJcbmV4cG9ydHMuZ2V0VHJhbnNhY3Rpb24gPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICB0cmFucy5maW5kKHthY2NvdW50dHM6IHJlcS5wYXJhbXMuYWNjb3VudHRzfSkudGhlbih0cmFuc2FjID0+IHtcclxuICAgIGlmKHRyYW5zYWMpe1xyXG4gICAgICBjb25zb2xlLmxvZyh0cmFuc2FjKVxyXG4gICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7dHJhbnNhYzogdHJhbnNhY30pOyAgICAgIC8vIOC4leC5ieC4reC4h+C4oeC4teC4leC4seC4p+C5geC4m+C4o+C4guC4reC4h+C4q+C4meC5ieC4suC5gOC4p+C5h+C4m+C4oeC4suC4o+C4seC4muC4hOC5iOC4siB0cmFuc2FjdGlvbiDguYTguJvguJTguYnguKfguKLguKLguLHguIfguYTguKHguYjguYTguJTguYnguJfguLNcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6IFwiTm8gdHJhbnNhY3Rpb25cIn0pO1xyXG4gICAgfVxyXG4gIH0pXHJcbn1cclxuIl19