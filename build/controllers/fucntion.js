var _this = this;

const User = require("../models/user");
const transac = require('../models/transactions');
const topup = require('../models/topup');

// function transfer
exports.transfer = (req, res, next) => {
  const ctmAcc = req.body.Account; // รับค่า Account ที่จะโอนเงินไป
  const oldAcc = req.body.accountts; // account ปัจจุบันที login ทำการโอนเงิน
  const tamount = req.body.amount; // จำนวนเงินที่โอน
  const transin = 'Transfer in';
  User.findOne({ account: ctmAcc }).then(result => {
    // หา account ที่จะส่งไปใน db อยู่ใน User collection
    if (!result) // ไม่มีใน db หรือ ซ้ำกับ account ที่ login
      {
        return res.status(404).json({ message: 'Account invalid' }); // return กลับ
      } else if (result.account == oldAcc) {
      return res.status(401).json({ message: 'Unable to perform transactions' });
    }
    // else if (result.balance < tamount) {
    //   return res.status(401).json({message: 'Not enough money in the account'})
    // }
    else {
        result.balance = result.balance + tamount; // ให้ balance ของ account ที่จะโอนทำการบวกเงินเพิ่ม

        const addtrans = new transac({ // ส่วนของเพิ่มใน transaction collection
          typeT: req.body.typeT, // type การทำรายการ
          amount: req.body.amount, // จำนวนเงิน
          account: req.body.Account, // ไปยัง account นี้
          accountts: req.body.accountts, // จาก account นี้
          created: Date.now() // วันเวลาปัจจุบัน
        });
        addtrans.save();

        const addtransin = new transac({ // ส่วนของเพิ่มใน transaction collection
          typeT: transin, // type การทำรายการ
          amount: req.body.amount, // จำนวนเงิน
          account: req.body.accountts, // ไปยัง account นี้
          accountts: req.body.Account, // จาก account นี้
          created: Date.now() // วันเวลาปัจจุบัน
        });
        addtransin.save();

        User.findOne({ account: oldAcc }).then(old => {
          // หา account ที่ login ใน db
          if (old.balance < tamount) {
            return res.status(401).json({ message: 'Not enough money in the account' });
          } else {
            old.balance = old.balance - tamount; // ทำการลบเงินออกจากบัญชี
            old.save().then(newb => {
              // save ลง db
              return res.status(201).json({ balance: newb.balance, message: 'Success' });
            });
          }
        });
        result.save();
      }
  });
};

// function topup
exports.topup = (req, res, next) => {
  const oldAcc = req.body.Account; // รับค่า account ปัจจุบัน
  const redeemcode = req.body.code; // รับค่า code

  topup.findOne({ recode: redeemcode }).then(result => {
    // หา code ใน topupcollection
    if (!result) {
      // ไม่มี return กลับ
      return res.status(404).json({ message: 'This code cant use' });
    }
    _this.getValue = result.amount; // เอา getvalue มาเก็บค่าของจำนวนเงินของ code นั้น
    console.log('topup' + _this.getValue);
    result.recode = result.recode + 'used'; // เปลี่ยนค่า code ให้มันใช้อีกรอบไม่ได้
    result.save(); // save ลง db
    // console.log(getValue)
    const addtrans = new transac({ // สร้าง transaction ใหม่
      typeT: req.body.typeT,
      amount: _this.getValue,
      account: '-',
      accountts: oldAcc,
      created: Date.now()
    });
    addtrans.save().then(result => {
      console.log(result);
    });
    User.findOne({ account: oldAcc }).then(results => {
      // หา account ใน user collection
      console.log('results' + results.balance);
      results.balance = results.balance + _this.getValue; // บวกเงินเพิ่มในบัญชี
      console.log('user' + results.balance);
      results.save().then(getbalance => {
        // save
        console.log(getbalance.balance);
        res.status(201).json({ balanced: getbalance.balance, message: 'Topup Success' }); // ส่งค่ากลับไปหน้าเว็ปส่ง balanced ไปให้มันอัพเดทค่าใน localstorage
      });
    });
  });
};

exports.payment = (req, res, next) => {
  const customerAcc = req.params.account;
  const shopAcc = req.query.shopacc;
  const price = parseFloat(req.query.price);

  User.findOne({ account: customerAcc }).then(result => {
    if (!result) {
      return res.status(404).json({ check: 0 });
    } else if (reslt.account == shopAcc) {
      return res.status(404).json({ check: 0 });
    } else if (result.balance < price) {
      return res.status(404).json({ check: 0 });
    } else {
      result.balance = result.balance - price;
      result.save();
      User.findOne({ account: shopAcc }).then(results => {
        if (!results) {
          return res.status(404).json({ check: 0 });
        } else {
          results.balance = results.balance + price;
          results.save();
          const addtrans = new transac({
            typeT: "Payment",
            amount: price,
            account: customerAcc,
            accountts: shopAcc,
            created: Date.now()
          });
          addtrans.save();
          const addtransin = new transac({
            typeT: "Payment in",
            amount: price,
            account: shopAcc,
            accountts: customerAcc,
            created: Date.now()
          });
          addtransin.save();
          return res.status(201).json({ check: 1 });
        }
      });
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9mdWNudGlvbi5qcyJdLCJuYW1lcyI6WyJVc2VyIiwicmVxdWlyZSIsInRyYW5zYWMiLCJ0b3B1cCIsImV4cG9ydHMiLCJ0cmFuc2ZlciIsInJlcSIsInJlcyIsIm5leHQiLCJjdG1BY2MiLCJib2R5IiwiQWNjb3VudCIsIm9sZEFjYyIsImFjY291bnR0cyIsInRhbW91bnQiLCJhbW91bnQiLCJ0cmFuc2luIiwiZmluZE9uZSIsImFjY291bnQiLCJ0aGVuIiwicmVzdWx0Iiwic3RhdHVzIiwianNvbiIsIm1lc3NhZ2UiLCJiYWxhbmNlIiwiYWRkdHJhbnMiLCJ0eXBlVCIsImNyZWF0ZWQiLCJEYXRlIiwibm93Iiwic2F2ZSIsImFkZHRyYW5zaW4iLCJvbGQiLCJuZXdiIiwicmVkZWVtY29kZSIsImNvZGUiLCJyZWNvZGUiLCJnZXRWYWx1ZSIsImNvbnNvbGUiLCJsb2ciLCJyZXN1bHRzIiwiZ2V0YmFsYW5jZSIsImJhbGFuY2VkIiwicGF5bWVudCIsImN1c3RvbWVyQWNjIiwicGFyYW1zIiwic2hvcEFjYyIsInF1ZXJ5Iiwic2hvcGFjYyIsInByaWNlIiwicGFyc2VGbG9hdCIsImNoZWNrIiwicmVzbHQiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsT0FBT0MsUUFBUSxnQkFBUixDQUFiO0FBQ0EsTUFBTUMsVUFBVUQsUUFBUSx3QkFBUixDQUFoQjtBQUNBLE1BQU1FLFFBQVFGLFFBQVEsaUJBQVIsQ0FBZDs7QUFFQTtBQUNBRyxRQUFRQyxRQUFSLEdBQW1CLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJQUFYLEtBQW9CO0FBQ3JDLFFBQU1DLFNBQVNILElBQUlJLElBQUosQ0FBU0MsT0FBeEIsQ0FEcUMsQ0FDRDtBQUNwQyxRQUFNQyxTQUFTTixJQUFJSSxJQUFKLENBQVNHLFNBQXhCLENBRnFDLENBRUQ7QUFDcEMsUUFBTUMsVUFBVVIsSUFBSUksSUFBSixDQUFTSyxNQUF6QixDQUhxQyxDQUdEO0FBQ3BD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Q2IsaUJBQU9qQyxJQUFJYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsRUFBQzZCLE9BQVEsQ0FBVCxFQUFyQixDQUFQO0FBQ0QsU0FGRCxNQUdLO0FBQ0hYLGtCQUFRaEIsT0FBUixHQUFtQmdCLFFBQVFoQixPQUFSLEdBQWtCeUIsS0FBckM7QUFDQVQsa0JBQVFWLElBQVI7QUFDQSxnQkFBTUwsV0FBVyxJQUFJdkIsT0FBSixDQUFZO0FBQzNCd0IsbUJBQU8sU0FEb0I7QUFFM0JYLG9CQUFRa0MsS0FGbUI7QUFHM0IvQixxQkFBUzBCLFdBSGtCO0FBSTNCL0IsdUJBQVdpQyxPQUpnQjtBQUszQm5CLHFCQUFTQyxLQUFLQyxHQUFMO0FBTGtCLFdBQVosQ0FBakI7QUFPQUosbUJBQVNLLElBQVQ7QUFDQSxnQkFBTUMsYUFBYSxJQUFJN0IsT0FBSixDQUFZO0FBQzdCd0IsbUJBQU8sWUFEc0I7QUFFN0JYLG9CQUFRa0MsS0FGcUI7QUFHN0IvQixxQkFBUzRCLE9BSG9CO0FBSTdCakMsdUJBQVcrQixXQUprQjtBQUs3QmpCLHFCQUFTQyxLQUFLQyxHQUFMO0FBTG9CLFdBQVosQ0FBbkI7QUFPQUUscUJBQVdELElBQVg7QUFDQSxpQkFBT3ZCLElBQUljLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixFQUFFNkIsT0FBTyxDQUFULEVBQXJCLENBQVA7QUFDRDtBQUNGLE9BekJEO0FBMEJEO0FBQ0YsR0F4Q0Q7QUEwQ0QsQ0FoREQiLCJmaWxlIjoiZnVjbnRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBVc2VyID0gcmVxdWlyZShcIi4uL21vZGVscy91c2VyXCIpO1xyXG5jb25zdCB0cmFuc2FjID0gcmVxdWlyZSgnLi4vbW9kZWxzL3RyYW5zYWN0aW9ucycpO1xyXG5jb25zdCB0b3B1cCA9IHJlcXVpcmUoJy4uL21vZGVscy90b3B1cCcpO1xyXG5cclxuLy8gZnVuY3Rpb24gdHJhbnNmZXJcclxuZXhwb3J0cy50cmFuc2ZlciA9IChyZXEsIHJlcyAsbmV4dCkgPT4ge1xyXG4gIGNvbnN0IGN0bUFjYyA9IHJlcS5ib2R5LkFjY291bnQ7ICAgIC8vIOC4o+C4seC4muC4hOC5iOC4siBBY2NvdW50IOC4l+C4teC5iOC4iOC4sOC5guC4reC4meC5gOC4h+C4tOC4meC5hOC4m1xyXG4gIGNvbnN0IG9sZEFjYyA9IHJlcS5ib2R5LmFjY291bnR0czsgIC8vIGFjY291bnQg4Lib4Lix4LiI4LiI4Li44Lia4Lix4LiZ4LiX4Li1IGxvZ2luIOC4l+C4s+C4geC4suC4o+C5guC4reC4meC5gOC4h+C4tOC4mVxyXG4gIGNvbnN0IHRhbW91bnQgPSByZXEuYm9keS5hbW91bnQ7ICAgIC8vIOC4iOC4s+C4meC4p+C4meC5gOC4h+C4tOC4meC4l+C4teC5iOC5guC4reC4mVxyXG4gIGNvbnN0IHRyYW5zaW4gPSAnVHJhbnNmZXIgaW4nO1xyXG4gIFVzZXIuZmluZE9uZSh7IGFjY291bnQ6IGN0bUFjYyB9KS50aGVuKHJlc3VsdCA9PiB7ICAgIC8vIOC4q+C4siBhY2NvdW50IOC4l+C4teC5iOC4iOC4sOC4quC5iOC4h+C5hOC4m+C5g+C4mSBkYiDguK3guKLguLnguYjguYPguJkgVXNlciBjb2xsZWN0aW9uXHJcbiAgICBpZighcmVzdWx0KSAgIC8vIOC5hOC4oeC5iOC4oeC4teC5g+C4mSBkYiDguKvguKPguLfguK0g4LiL4LmJ4Liz4LiB4Lix4LiaIGFjY291bnQg4LiX4Li14LmIIGxvZ2luXHJcbiAgICB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7bWVzc2FnZTogJ0FjY291bnQgaW52YWxpZCd9KSAgICAvLyByZXR1cm4g4LiB4Lil4Lix4LiaXHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggcmVzdWx0LmFjY291bnQgPT0gb2xkQWNjKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7bWVzc2FnZTogJ1VuYWJsZSB0byBwZXJmb3JtIHRyYW5zYWN0aW9ucyd9KVxyXG4gICAgfVxyXG4gICAgLy8gZWxzZSBpZiAocmVzdWx0LmJhbGFuY2UgPCB0YW1vdW50KSB7XHJcbiAgICAvLyAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7bWVzc2FnZTogJ05vdCBlbm91Z2ggbW9uZXkgaW4gdGhlIGFjY291bnQnfSlcclxuICAgIC8vIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICByZXN1bHQuYmFsYW5jZSA9IHJlc3VsdC5iYWxhbmNlICsgdGFtb3VudDsgICAgLy8g4LmD4Lir4LmJIGJhbGFuY2Ug4LiC4Lit4LiHIGFjY291bnQg4LiX4Li14LmI4LiI4Liw4LmC4Lit4LiZ4LiX4Liz4LiB4Liy4Lij4Lia4Lin4LiB4LmA4LiH4Li04LiZ4LmA4Lie4Li04LmI4LihXHJcblxyXG4gICAgICBjb25zdCBhZGR0cmFucyA9IG5ldyB0cmFuc2FjKHsgICAgLy8g4Liq4LmI4Lin4LiZ4LiC4Lit4LiH4LmA4Lie4Li04LmI4Lih4LmD4LiZIHRyYW5zYWN0aW9uIGNvbGxlY3Rpb25cclxuICAgICAgICB0eXBlVDogcmVxLmJvZHkudHlwZVQsICAgICAgICAvLyB0eXBlIOC4geC4suC4o+C4l+C4s+C4o+C4suC4ouC4geC4suC4o1xyXG4gICAgICAgIGFtb3VudDogcmVxLmJvZHkuYW1vdW50LCAgICAgIC8vIOC4iOC4s+C4meC4p+C4meC5gOC4h+C4tOC4mVxyXG4gICAgICAgIGFjY291bnQ6IHJlcS5ib2R5LkFjY291bnQsICAgIC8vIOC5hOC4m+C4ouC4seC4hyBhY2NvdW50IOC4meC4teC5iVxyXG4gICAgICAgIGFjY291bnR0czogcmVxLmJvZHkuYWNjb3VudHRzLCAgICAvLyDguIjguLLguIEgYWNjb3VudCDguJnguLXguYlcclxuICAgICAgICBjcmVhdGVkOiBEYXRlLm5vdygpICAgICAvLyDguKfguLHguJnguYDguKfguKXguLLguJvguLHguIjguIjguLjguJrguLHguJlcclxuICAgICAgfSlcclxuICAgICAgYWRkdHJhbnMuc2F2ZSgpO1xyXG5cclxuICAgICAgY29uc3QgYWRkdHJhbnNpbiA9IG5ldyB0cmFuc2FjKHsgICAgLy8g4Liq4LmI4Lin4LiZ4LiC4Lit4LiH4LmA4Lie4Li04LmI4Lih4LmD4LiZIHRyYW5zYWN0aW9uIGNvbGxlY3Rpb25cclxuICAgICAgICB0eXBlVDogdHJhbnNpbiwgICAgICAgIC8vIHR5cGUg4LiB4Liy4Lij4LiX4Liz4Lij4Liy4Lii4LiB4Liy4LijXHJcbiAgICAgICAgYW1vdW50OiByZXEuYm9keS5hbW91bnQsICAgICAgLy8g4LiI4Liz4LiZ4Lin4LiZ4LmA4LiH4Li04LiZXHJcbiAgICAgICAgYWNjb3VudDogcmVxLmJvZHkuYWNjb3VudHRzLCAgICAvLyDguYTguJvguKLguLHguIcgYWNjb3VudCDguJnguLXguYlcclxuICAgICAgICBhY2NvdW50dHM6IHJlcS5ib2R5LkFjY291bnQsICAgIC8vIOC4iOC4suC4gSBhY2NvdW50IOC4meC4teC5iVxyXG4gICAgICAgIGNyZWF0ZWQ6IERhdGUubm93KCkgICAgIC8vIOC4p+C4seC4meC5gOC4p+C4peC4suC4m+C4seC4iOC4iOC4uOC4muC4seC4mVxyXG4gICAgICB9KVxyXG4gICAgICBhZGR0cmFuc2luLnNhdmUoKVxyXG5cclxuICAgICAgVXNlci5maW5kT25lKHsgYWNjb3VudDogb2xkQWNjIH0pLnRoZW4oIG9sZCA9PiB7IC8vIOC4q+C4siBhY2NvdW50IOC4l+C4teC5iCBsb2dpbiDguYPguJkgZGJcclxuICAgICAgICBpZihvbGQuYmFsYW5jZSA8IHRhbW91bnQpe1xyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHttZXNzYWdlOiAnTm90IGVub3VnaCBtb25leSBpbiB0aGUgYWNjb3VudCd9KVxyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgb2xkLmJhbGFuY2UgPSBvbGQuYmFsYW5jZSAtIHRhbW91bnQ7ICAgIC8vIOC4l+C4s+C4geC4suC4o+C4peC4muC5gOC4h+C4tOC4meC4reC4reC4geC4iOC4suC4geC4muC4seC4jeC4iuC4tVxyXG4gICAgICAgICAgb2xkLnNhdmUoKS50aGVuKCBuZXdiID0+IHsgICAgLy8gc2F2ZSDguKXguIcgZGJcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMSkuanNvbih7YmFsYW5jZTogbmV3Yi5iYWxhbmNlLCBtZXNzYWdlOiAnU3VjY2Vzcyd9KVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIHJlc3VsdC5zYXZlKCk7XHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuXHJcbi8vIGZ1bmN0aW9uIHRvcHVwXHJcbmV4cG9ydHMudG9wdXAgPSAocmVxICxyZXMsIG5leHQpID0+IHtcclxuICBjb25zdCBvbGRBY2MgPSByZXEuYm9keS5BY2NvdW50OyAgICAvLyDguKPguLHguJrguITguYjguLIgYWNjb3VudCDguJvguLHguIjguIjguLjguJrguLHguJlcclxuICBjb25zdCByZWRlZW1jb2RlID0gcmVxLmJvZHkuY29kZTsgICAvLyDguKPguLHguJrguITguYjguLIgY29kZVxyXG5cclxuICB0b3B1cC5maW5kT25lKHtyZWNvZGU6IHJlZGVlbWNvZGV9KS50aGVuKHJlc3VsdCA9PiB7ICAgIC8vIOC4q+C4siBjb2RlIOC5g+C4mSB0b3B1cGNvbGxlY3Rpb25cclxuICAgIGlmKCFyZXN1bHQpeyAgICAgICAgLy8g4LmE4Lih4LmI4Lih4Li1IHJldHVybiDguIHguKXguLHguJpcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ1RoaXMgY29kZSBjYW50IHVzZSd9KTtcclxuICAgIH1cclxuICAgIHRoaXMuZ2V0VmFsdWUgPSByZXN1bHQuYW1vdW50OyAgICAvLyDguYDguK3guLIgZ2V0dmFsdWUg4Lih4Liy4LmA4LiB4LmH4Lia4LiE4LmI4Liy4LiC4Lit4LiH4LiI4Liz4LiZ4Lin4LiZ4LmA4LiH4Li04LiZ4LiC4Lit4LiHIGNvZGUg4LiZ4Lix4LmJ4LiZXHJcbiAgICBjb25zb2xlLmxvZygndG9wdXAnK3RoaXMuZ2V0VmFsdWUpXHJcbiAgICByZXN1bHQucmVjb2RlID0gcmVzdWx0LnJlY29kZSArICd1c2VkJyAgICAvLyDguYDguJvguKXguLXguYjguKLguJnguITguYjguLIgY29kZSDguYPguKvguYnguKHguLHguJnguYPguIrguYnguK3guLXguIHguKPguK3guJrguYTguKHguYjguYTguJTguYlcclxuICAgIHJlc3VsdC5zYXZlKCkgICAgICAgLy8gc2F2ZSDguKXguIcgZGJcclxuICAgIC8vIGNvbnNvbGUubG9nKGdldFZhbHVlKVxyXG4gICAgY29uc3QgYWRkdHJhbnMgPSBuZXcgdHJhbnNhYyh7ICAgIC8vIOC4quC4o+C5ieC4suC4hyB0cmFuc2FjdGlvbiDguYPguKvguKHguYhcclxuICAgICAgdHlwZVQ6IHJlcS5ib2R5LnR5cGVULFxyXG4gICAgICBhbW91bnQ6IHRoaXMuZ2V0VmFsdWUsXHJcbiAgICAgIGFjY291bnQ6ICctJyxcclxuICAgICAgYWNjb3VudHRzOiBvbGRBY2MsXHJcbiAgICAgIGNyZWF0ZWQ6IERhdGUubm93KClcclxuICAgIH0pXHJcbiAgICBhZGR0cmFucy5zYXZlKCkudGhlbiggcmVzdWx0ID0+IHtcclxuICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcclxuICAgIH0pXHJcbiAgICBVc2VyLmZpbmRPbmUoe2FjY291bnQ6IG9sZEFjY30pLnRoZW4oIHJlc3VsdHMgPT4geyAgICAgIC8vIOC4q+C4siBhY2NvdW50IOC5g+C4mSB1c2VyIGNvbGxlY3Rpb25cclxuICAgICAgY29uc29sZS5sb2coJ3Jlc3VsdHMnKyByZXN1bHRzLmJhbGFuY2UpXHJcbiAgICAgIHJlc3VsdHMuYmFsYW5jZSA9IHJlc3VsdHMuYmFsYW5jZSArIHRoaXMuZ2V0VmFsdWU7ICAgIC8vIOC4muC4p+C4geC5gOC4h+C4tOC4meC5gOC4nuC4tOC5iOC4oeC5g+C4meC4muC4seC4jeC4iuC4tVxyXG4gICAgICBjb25zb2xlLmxvZygndXNlcicrIHJlc3VsdHMuYmFsYW5jZSlcclxuICAgICAgcmVzdWx0cy5zYXZlKCkudGhlbihnZXRiYWxhbmNlID0+IHsgICAgIC8vIHNhdmVcclxuICAgICAgICBjb25zb2xlLmxvZyhnZXRiYWxhbmNlLmJhbGFuY2UpXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oeyBiYWxhbmNlZDogZ2V0YmFsYW5jZS5iYWxhbmNlLCBtZXNzYWdlOiAnVG9wdXAgU3VjY2Vzcyd9KSAgIC8vIOC4quC5iOC4h+C4hOC5iOC4suC4geC4peC4seC4muC5hOC4m+C4q+C4meC5ieC4suC5gOC4p+C5h+C4m+C4quC5iOC4hyBiYWxhbmNlZCDguYTguJvguYPguKvguYnguKHguLHguJnguK3guLHguJ7guYDguJTguJfguITguYjguLLguYPguJkgbG9jYWxzdG9yYWdlXHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG4gIH0pXHJcbn1cclxuXHJcblxyXG5leHBvcnRzLnBheW1lbnQgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICBjb25zdCBjdXN0b21lckFjYyA9IHJlcS5wYXJhbXMuYWNjb3VudDtcclxuICBjb25zdCBzaG9wQWNjID0gcmVxLnF1ZXJ5LnNob3BhY2M7XHJcbiAgY29uc3QgcHJpY2UgPSBwYXJzZUZsb2F0KHJlcS5xdWVyeS5wcmljZSk7XHJcblxyXG5cclxuICBVc2VyLmZpbmRPbmUoeyBhY2NvdW50OiBjdXN0b21lckFjY30pLnRoZW4oIHJlc3VsdCA9PntcclxuICAgIGlmKCFyZXN1bHQpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtjaGVjayA6IDB9KVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAocmVzbHQuYWNjb3VudCA9PSBzaG9wQWNjKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7Y2hlY2sgOiAwfSlcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCByZXN1bHQuYmFsYW5jZSA8IHByaWNlICkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe2NoZWNrIDogMH0pXHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgcmVzdWx0LmJhbGFuY2UgPSByZXN1bHQuYmFsYW5jZSAtIHByaWNlO1xyXG4gICAgICByZXN1bHQuc2F2ZSgpXHJcbiAgICAgIFVzZXIuZmluZE9uZSh7IGFjY291bnQ6IHNob3BBY2N9KS50aGVuKCByZXN1bHRzID0+e1xyXG4gICAgICAgIGlmKCAhcmVzdWx0cyApIHtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7Y2hlY2sgOiAwfSlcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICByZXN1bHRzLmJhbGFuY2UgID0gcmVzdWx0cy5iYWxhbmNlICsgcHJpY2VcclxuICAgICAgICAgIHJlc3VsdHMuc2F2ZSgpO1xyXG4gICAgICAgICAgY29uc3QgYWRkdHJhbnMgPSBuZXcgdHJhbnNhYyh7XHJcbiAgICAgICAgICAgIHR5cGVUOiBcIlBheW1lbnRcIiAsXHJcbiAgICAgICAgICAgIGFtb3VudDogcHJpY2UsXHJcbiAgICAgICAgICAgIGFjY291bnQ6IGN1c3RvbWVyQWNjLFxyXG4gICAgICAgICAgICBhY2NvdW50dHM6IHNob3BBY2MsXHJcbiAgICAgICAgICAgIGNyZWF0ZWQ6IERhdGUubm93KClcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICBhZGR0cmFucy5zYXZlKCk7XHJcbiAgICAgICAgICBjb25zdCBhZGR0cmFuc2luID0gbmV3IHRyYW5zYWMoe1xyXG4gICAgICAgICAgICB0eXBlVDogXCJQYXltZW50IGluXCIsXHJcbiAgICAgICAgICAgIGFtb3VudDogcHJpY2UsXHJcbiAgICAgICAgICAgIGFjY291bnQ6IHNob3BBY2MsXHJcbiAgICAgICAgICAgIGFjY291bnR0czogY3VzdG9tZXJBY2MsXHJcbiAgICAgICAgICAgIGNyZWF0ZWQ6IERhdGUubm93KClcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICBhZGR0cmFuc2luLnNhdmUoKTtcclxuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMSkuanNvbih7IGNoZWNrOiAxfSlcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgfSlcclxuXHJcbn1cclxuIl19